# Methodology {#sec-methods}

```{r, include = FALSE}
# load R libraries here; the `include` flag in the chunk options above tells
# whether to print the results or not. Usually you don't want to print the
# library statements, or any code on the pdf.
# Main Packages ========
# I use these in every doc
library(tidyverse)
library(knitr)
library(kableExtra)
library(modelsummary)
library(targets)
options(dplyr.summarise.inform = FALSE)
# Other packages ------
# These sometimes get used, and sometimes don't.
library(leaflet)
library(sf)
library(viridis)
library(ggspatial)
# Instructions and options =========
# prints missing data in tables as blank space
options(knitr.kable.NA = '') 
# tells kableExtra to not load latex table packages in the chunk output
options(kableExtra.latex.load_packages = FALSE) 
# round and format numbers that get printed in the text of the article.
inline_hook <- function(x) {
  if (is.numeric(x)) {
    format(x, digits = 3, big.mark = ",")
  } else x
}
knitr::knit_hooks$set(inline = inline_hook)
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
# options for latex-only output
if(knitr::is_latex_output()) {
  knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
} 
theme_set(theme_bw())
```

This section first presents the design of the transportation forecasting
model used in this research, followed by a discussion of the sampling
methodology used to generate multiple alternative runs of the model.

## Transportation Demand Model

The Roanoke Valley Transportation Planning Organization (RVTPO)
transportation demand model[^03-methods-1] is an advanced trip-based
formulation with the following basic procedure for internal passenger
trips:

[^03-methods-1]: A fork of the RVTPO model is available on
    [GitHub](https://github.com/gregmacfarlane/rvtpo), and is used with
    permission for educational and research purposes.

1.  **Trip production** by cross-classified trip rates varying by trip
    purpose, household size, vehicle ownership, and number of workers.
    These rates are multiplied by household socioeconomic data by zone.
2.  **Mode choice** utility equations varying by purpose using highway,
    non-motorized, and travel time skims.
3.  **Destination choice** utility equations incorporating destination
    size coefficients and using the mode choice logsum as an impedance
    term.
4.  **Time of Day** factors transform a daily matrix of trip productions
    and attractions into period matrices of trips from origins to
    destinations.
5.  **Highway assignment** by multi-class static user equilibrium, with
    through freight and passenger trips preloaded in each period.

The RVTPO model provides an ideal testing environment for this research
because it uses an integrated mode and destination choice framework
common in more advanced trip-based models. At the same time, its small
size (approximately 215 zones) means the entire model runs in a few
minutes allowing for efficient testing of multiple model runs.

The total passenger trips $T$ traveling from zone $i$ to zone $j$ on the
highway in a period $t$ is therefore

$$
  T_{ijt} = P_i * \mathcal{P}_{\mathrm{car}}(\beta, C_{ijt}) * \mathcal{P}_{\mathrm{j}}(\gamma, A_j, MCLS_{ijt}) * \Delta_t
$$ {#eq-overall}

where $P$ is the productions at zone $i$ ; $\mathcal{P}_{\mathrm{car}}$
is the car mode choice probability determined by utility parameters
$\beta$ and the travel costs $C$ between $i$ and $j$ at time period $t$
; $\mathcal{P}_{j}$ is the destination choice probability of choosing
destination $j$ given the utility parameters , $\gamma$ attractions $A$,
and the impedance as the mode choice model logsum $MCLS_{ijt}$. A
time-of-day and direction factor $\Delta$ finalizes the total assigned
trips.

The two parameter vectors $\beta$ and $\gamma$ describe the mode choice
model and destination choice model coefficients, respectively. Both
models use a multinomial logit framework with coefficients varying by
purpose, as given in @tbl-coeffs. In addition to these coefficients, the
destination choice model utility equation includes the mode choice model
log sum term with a coefficient of 1,

$$
 U_{ij} = \gamma X_j + 1 * MCLS_{ij}
$$ {#eq-destination}

with $X_j$ representing the socioeconomic data in zone \$j\$.
Additionally, both the mode choice and destination choice models include
calibration components: a set of constants for each alternative in the
mode choice model and a cubic polynomial in the destination choice
model. These values are not presented in @tbl-coeffs for simplicity and
because we do not perturb them in the simulation analysis. The travel
costs $C_{ij}$ in the mode choice model use a congested travel time skim
from a calibrated version of the RVTPO model.

```{r coeffs}
#| label: tbl-coeffs
#| tbl-cap: Choice Model Coefficients
tar_load(mc_coeff)
tar_load(dc_coeff)

coefficient_table <- bind_rows(
  mc_coeff |> mutate(model = "Mode choice") |> 
    select(Name, HBW, HBO, NHB) |> 
    filter(Name %in% c("CIVTT", "CCOST", "CWALK1", "CWALK2")) |> 
    mutate(Name = c("In-vehicle time", "Cost", "Walk < 1 mile", "Walk > 1 mile")),
  dc_coeff |> mutate(model = "Destination choice") |> 
    select(Name = VAR, HBW, HBO, NHB) |> 
    filter(Name %in% c("HH", "I(OTH_EMP + OFF_EMP)", "OFF_EMP", "OTH_EMP",
                       "RET_EMP")) |> 
    mutate(Name = c("Households", "Other + Office", "Office", "Other", "Retail"))
  )

kbl(coefficient_table, booktabs = TRUE,
    col.names = c("", "HBW", "HBO", "NHB"), digits = 4) %>%
  kable_styling() %>%
  pack_rows(index = c("Mode Choice" = 4, "Destination Choice" = 5))
```

In our application, we treat the trip production rates as fixed based on
the existing RVTPO trip rates. Similarly, we hold the assignment
procedures including volume-delay curves fixed. We also hold fixed all
passenger trip purposes not included in @tbl-coeffs (school trips, for
example), as well as internal commercial trips and all internal/external
trips.

## Parameter Sampling

Using the trip-based model described above, we sample new coefficients
for the terms presented in @tbl-coeffs. Given that Latin hypercube
sampling (LHS) has been shown to generate multidimensional parameter
draws covering complex parameter spaces in an efficient pattern relative
to Monte Carlo sampling [@helton2003], we apply LHS [@carnell2022] to
the each coefficient assuming that the mean is as described in
@tbl-coeffs and that each coefficient has a mean an inherent coefficient
of variation of 0.1. This is smaller than the value of 0.3 that
@zhao2002 assumed, but in our examinations the higher variation
frequently led to unrealistic implied values of time in the mode choice
model.

@fig-ndraws shows the cumulative standard deviation in the home-based
work (HBW) mode choice logsum term as the number of LHS parameter draws
increases, as well as a ribbon defining the 95% confidence interval of
this estimate. As the number of draws increases, the estimate of the
total variance stabilizes at around 100. As a consequence of this
analysis, we select 100 as the number of draws for this analysis.

```{r ndraws}
#| label: fig-ndraws
#| fig-cap: Cumulative standard deviation in mode choice logsum for HBW trips.
tar_load(hbw_stats_400) 

hbw_stats_400 %>%
  filter(type != "base") %>%
  filter(type != "MC") %>%
  ggplot() +
    aes(x = draw, y = cummean, 
        ymin = cummean - 1.96*cumvar, 
        ymax = cummean + 1.96*cumvar) +
    geom_ribbon(alpha = 0.2, color = NA) +
    geom_line(size = 0.5) +
#    ylim(0.025, 0.15) +
    labs(x = "Draw", 
         y = "Cumulative Standard Deviation",
         color = "method") +
    scale_color_hue(direction = 1) +
    theme_linedraw() +
    theme(legend.position = "bottom") 
```
