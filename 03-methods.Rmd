# Model Design and Methodology

```{r, include = FALSE}
some_packages <- c("tidyverse", "bookdown", "omxr", "nhts2017", "rgdal", "sf", "ggthemes", "lhs", "foreign", "imputeTS", "targets", "readxl", "knitr", "gridExtra", "ggspatial")
lapply(some_packages, library, character.only=TRUE)
```

## Overview

## Transportation Demand Model

To examine the effects of parameter input sensitivity, we developed a trip-based travel model with four steps:

1.  trip generation,
2.  trip distribution,
3.  mode choice, and
4.  destination choice.

Trip generation, the first step, was conducted using socioeconomic (SE) data and household trip productions from Roanoke Valley Transportation Planning Organization [RVTPO](https://github.com/xinwangvdot/rvtpo). The trip productions were summarized by household sizes, vehicles, and workers, and the weighted mean of each trip purpose was taken. The three trip purposes used are Home Based Work (HBW), Home Based Other (HBO), and Non-Home Based (NHB). Trip attraction was skipped for this analysis.

The second step, trip distribution, used distance and travel time skims from RVTPO. The skims were simplified to use auto, nonmotorized, and transit modes. Travel time for auto used the single occupancy vehicle peak time, nonmotorized travel time used the distance skim multiplied by a factor of average walking speed (3 mph), and transit time used the walk to bus peak time.

Mode choice, the third step, calculates utilities for the three modes. These utilities were exponentiated, added together, and the natural log was taken to get a logsum value for every origin and destination pair. The utility equations for the mode choice model are as follows:

\begin{equation}
\mathrm{drive\_utility} = (\mathrm{coeff\_ivtt}*\mathrm{auto})+(\mathrm{coeff\_cost}*\mathrm{auto\_cost}*\mathrm{DIST})
(\#eq:driveutil)
\end{equation} \begin{equation}
\mathrm{nonmo\_utility} = (\mathrm{k\_nmot}+ 20 * (\mathrm{coeff\_walk1}*\mathrm{nonmotor}))
(\#eq:nonmoutil)
\end{equation} \begin{equation}
\mathrm{trans\_utility} = \mathrm{k\_trn} + (\mathrm{coeff\_ivtt}*\mathrm{transit})
(\#eq:transutil)
\end{equation}

The mode choice parameters (constants and coefficients) were obtained from the [USTM Resiliency Model](https://github.com/byu-transpolab/ustm_resiliency). These values are shown in Table \@ref(tab:MCcoeff) and Table \@ref(tab:MCconst).

```{r MCcoeff, echo = FALSE, results = 'axis', fig.cap = "Mode Choice Coefficients"}
tar_load(mc_coeff)
mc_coeff2 <- mc_coeff %>%
  filter(Name %in% c("CIVTT", "CCOST", "CWALK1", "AUTOCOST"))

kable(mc_coeff2[,2:5], caption = "Mode Choice Coefficients", booktabs = TRUE)
```

```{r MCconst, echo = FALSE, results = 'axis', fig.cap = "Mode Choice Constants"}
tar_load(mc_const)
mc_const2 <- mc_const %>%
  filter(Name %in% c("K_TRN", "K_NMOT"))

kable(mc_const2[,2:5], caption = "Mode Choice Constants", booktabs = TRUE)
```

The final step, destination choice, uses the mode choice logsum as the primary impedance, and a size term calculated using zonal employment. The destination choice utility is the impedance term added to the log of the size term. The destination choice parameters (constants and coefficients) were also obtained from the [USTM Resiliency Model](https://github.com/byu-transpolab/ustm_resiliency). These values are shown in Table \@ref(tab:DCcoeff).


```{r DCcoeff, echo = FALSE, results = 'axis', fig.cap = "Destination Choice Parameters"}
tar_load(dc_coeff)

kable(dc_coeff[1:10,2:5], caption = "Destination Choice Parameters", booktabs = TRUE)
```

The four-step model gives data in terms of utilities and probabilities. This can be turned into production and attraction trips, and then a highway assignment can be applied using CUBE.

## Parameter Sampling

With this four-step model, MC and LHS methods were used to determine the possible combinations of parameter variance. To identify a standard deviation for each parameter, a coefficient of variation was used. A set coefficient of variation of 0.10 was used for all six mode choice input parameters, and four of the destination choice parameters (HH, OFF_EMP, OTH_EMP, and RET_EMP). Literature had identified a coefficient of variation of 0.30, but for this analysis that caused an unrealistic value of time, and thus it was changed to be 0.10 [@zhao2002propagation]. The standard deviation was equal to 0.10 multiplied by the mean, where the mean values in this situation are the base scenario parameters (as identified in Table \@ref(tab:MCcoeff), Table \@ref(tab:MCconst), and Table \@ref(tab:MCconst)).

The MC random sampling uses the R function of `rnorm`. LHS uses the `lhs` package in R. Since this package only chooses variables on a zero to one scale, the values given use a function to put the random sampling on the right scale needed for the given parameter. The full code for both methods can be found in a public [GitHub repository](https://github.com/natmaegray/sensitivity_thesis). 100 and 400 draws of random samples for both methods are generated. With these generated parameters, the mode choice model step was run for every set of input parameters for each purpose. The mean logsum value for each run was determined to compare each continuous draw. This allowed us to see how many iterations of which sampling type would be sufficient to show a full range of possible outcomes.

## Summary

A standard four-step model was created in R to create trips, and evaluate sampling methodologies. 