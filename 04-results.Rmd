# Sensitivity Analysis Results

```{r , include = FALSE}
some_packages <- c("tidyverse", "bookdown", "omxr", "nhts2017", "rgdal", "sf", "ggthemes", "lhs", "foreign", "imputeTS", "targets", "readxl", "knitr", "gridExtra", "ggspatial")
lapply(some_packages, library, character.only=TRUE)

tar_load(networks)

base <- read.dbf("data/sensitivity_out/BASE_LOADED.DBF") %>%
  mutate(link = paste(A, B, sep = "_"))
```

## Overview

## Sampling Findings

The parameters generated were compared for both sampling methods. Figure \@ref(fig:parameter100) shows the distributions for the HBW parameters when using 100 draws, and Figure \@ref(fig:parameter600) shows how that changes when using 600 draws. These distributions show that LHS gives normally distributed parameters with fewer draws than MC sampling. At 100 draws LHS shows a nearly perfect normal distribution, where there are some discrepancies for the MC generated parameters. Without looking at the mode choice results, these Figures show that LHS is likely to estimate the full variance of the results with much fewer draws.

```{r parameter100, echo = FALSE, fig.align="center", results='asis', out.width = "75%", fig.cap = "HBW Distributions for Input Parameters with 100 Draws"}
tar_load(hbw_mc_coeff_lists_100)
list100 <- hbw_mc_coeff_lists_100

Z <- bind_rows(list100) %>% 
  mutate(method = c("base", rep("MC", 100), rep("LHS", 100))) %>% 
  mutate(vot = (ivtt/ccost) * (60/100)) %>%
  pivot_longer(cols = -c("method"))

Z %>%
  filter(!(method %in% "base")) %>%
  ggplot() +
  aes(x = value, color = method, fill = method) +
  geom_density(alpha = 0.25) +
  scale_fill_hue(direction = 1) +
  labs(y = "Density",
       x = "Value") +
  theme_linedraw() +
  theme(legend.position = "bottom") +
  facet_wrap(vars(name), scales = "free")
```

```{r parameter600, echo = FALSE, fig.align="center", results='asis', out.width = "75%", fig.cap = "HBW Distributions for Input Parameters with 600 Draws"}
tar_load(hbw_mc_coeff_lists_600)
list600 <- hbw_mc_coeff_lists_600

Z <- bind_rows(list600) %>% 
  mutate(method = c("base", rep("MC", 600), rep("LHS", 600))) %>%
  mutate(vot = (ivtt/ccost) * (60/100)) %>%
  pivot_longer(cols = -c("method"))

Z %>%
  filter(!(method %in% "base")) %>%
  ggplot() +
  aes(x = value, color = method, fill = method) +
  geom_density(alpha = 0.25) +
  scale_fill_hue(direction = 1) +
  labs(y = "Density",
       x = "Value") +
  theme_linedraw() +
  theme(legend.position = "bottom") +
  facet_wrap(vars(name), scales = "free")
```

To determine if LHS is effective at a reasonable amount of iterations, the standard deviation was calculated for each additional draw. This value shows how much the mean mode choice logsum value for all zones can vary. When the standard deviation for the draws stabilizes, that shows that the amount of generated parameters has captured all of the possible variances of the results. This can be visualized for each purpose. The HBW results for the cumulative standard deviation are shown in \@ref(fig:hbwstats). The results for the other two purposes (HBO and NHB) are in \@ref(fig:hbostats) and \@ref(fig:nhbstats) respectively. 

```{r hbwstats, warning = FALSE, echo = FALSE, message = FALSE, fig.align="center", out.width = "75%", results='asis', fig.cap = "HBW Mean Logsum Standard Variation with 100 and 600 Draws"}
tar_load(hbw_stats_100)
tar_load(hbw_stats_600)
hbw_stats <- bind_rows(hbw_stats_100, hbw_stats_600, .id = "ndraws") %>%
  mutate(ndraws = case_when(ndraws == "1" ~ "100 Draws",
                          ndraws == "2" ~ "600 Draws"))

hbw_stats %>%
  filter(type != "base") %>%
  ggplot() +
    aes(x = draw, y = cummean, ymin = cummean - 1.96*cumvar, ymax = cummean + 1.96*cumvar, colour = type, fill = type, group = type) +
    geom_ribbon(alpha = 0.2, colour = NA) +
    geom_line(size = 0.5) +
#    ylim(0.025, 0.15) +
    labs(x = "Draw", 
         y = "Cumulative Standard Deviation",
         color = "method") +
    scale_color_hue(direction = 1) +
    theme_linedraw() +
    theme(legend.position = "bottom") +
    facet_wrap(vars(ndraws), scales = "free_x")
```

```{r hbostats, warning = FALSE, echo = FALSE, message = FALSE, fig.align="center", out.width = "75%", results='asis', fig.cap = "HBO Mean Logsum Standard Variation with 100 and 600 Draws"}
tar_load(hbo_stats_100)
tar_load(hbo_stats_600)
hbo_stats <- bind_rows(hbo_stats_100, hbo_stats_600, .id = "ndraws") %>%
  mutate(ndraws = case_when(ndraws == "1" ~ "100 Draws",
                          ndraws == "2" ~ "600 Draws"))

hbo_stats %>%
  filter(type != "base") %>%
  ggplot() +
    aes(x = draw, y = cummean, ymin = cummean - 1.96*cumvar, ymax = cummean + 1.96*cumvar, colour = type, fill = type, group = type) +
    geom_ribbon(alpha = 0.2, colour = NA) +
    geom_line(size = 0.5) +
#    ylim(0.025, 0.15) +
    labs(x = "Draw", 
         y = "Cumulative Standard Deviation",
         color = "method") +
    scale_color_hue(direction = 1) +
    theme_linedraw() +
    theme(legend.position = "bottom") +
    facet_wrap(vars(ndraws), scales = "free_x")
```

```{r nhbstats, warning = FALSE, echo = FALSE, message = FALSE, fig.align="center", out.width = "75%", results='asis', fig.cap = "NHB Mean Logsum Standard Variation with 100 and 600 Draws"}
tar_load(nhb_stats_100)
tar_load(nhb_stats_600)
nhb_stats <- bind_rows(nhb_stats_100, nhb_stats_600, .id = "ndraws") %>%
  mutate(ndraws = case_when(ndraws == "1" ~ "100 Draws",
                          ndraws == "2" ~ "600 Draws"))

nhb_stats %>%
  filter(type != "base") %>%
  ggplot() +
    aes(x = draw, y = cummean, ymin = cummean - 1.96*cumvar, ymax = cummean + 1.96*cumvar, colour = type, fill = type, group = type) +
    geom_ribbon(alpha = 0.2, colour = NA) +
    geom_line(size = 0.5) +
#    ylim(0.025, 0.15) +
    labs(x = "Draw", 
         y = "Cumulative Standard Deviation",
         color = "method") +
    scale_color_hue(direction = 1) +
    theme_linedraw() +
    theme(legend.position = "bottom") +
    facet_wrap(vars(ndraws), scales = "free_x")
```

For all three trip purposes, the LHS method had its standard deviation stabilized between 100 and 200 draws. The MC method had still not stabilized to the same extent after 600 draws. This shows us that Latin Hypercube Sampling greatly decreases the iterations needed to approximate random sampling methods. Since LHS captures the possible variance at a small enough amount of iterations, it can be used for large transportation demand models.

## Roanoke Valley Results

A hundred iterations of Latin Hypercube sampling was created with the RVPTO data. Some ways this data can be analyzed to evaluate the range of results is with the highway assignment applied after the four-step model. The coefficient of variation among all iterations for every link in the transportation network can be calculated and compared. Figure \@ref(fig:totalvolume) shows, by facility type, how the total volume varies. It can be seen that the higher volume roads, have less variability, and the roads with low volume have more variability.

```{r totalvolume, echo = FALSE, results = 'axis', fig.align="center", out.width = "75%", warning = FALSE, fig.cap = "Coefficient of Variation of Total Link Volume"}
## Total Volume
links_total <- networks %>%
  group_by(link) %>%
  summarize(sd = sd(TOTAL_VOL),
            mean = mean(TOTAL_VOL))

base_total <- merge(base, links_total, by = "link") %>%
  mutate(cov = sd/mean) %>%
  filter(FACTYPE < 11, mean >0 ) %>%
  mutate(FacilityType = case_when(FACTYPE == 1 ~ "1, 2 - Freeway",
                                  FACTYPE == 2 ~ "1, 2 - Freeway",
                                  FACTYPE == 3 ~ "3, 4, 5 - Arterial",
                                  FACTYPE == 4 ~ "3, 4, 5 - Arterial",
                                  FACTYPE == 5 ~ "3, 4, 5 - Arterial",
                                  FACTYPE == 6 ~ "6, 7 - Collector",
                                  FACTYPE == 7 ~ "6, 7 - Collector",
                                  FACTYPE == 8 ~ "8 - Local",
                                  FACTYPE == 9 ~ "9, 10 - Ramp",
                                  FACTYPE == 10 ~ "9, 10 - Ramp",))

ggplot(base_total) +
  aes(x = TOTAL_VOL, y = cov, color = FacilityType) +
  geom_point(shape = "circle", size = 1.5, alpha = 0.35) +
  theme_linedraw() + scale_y_log10() +
  labs(x = "Total Link Volume",
       y = "log(Coefficient of Variation)",
       color = "Facility Type")
```

Variation among a link can also be visualized with a density plot of the total volume across all iterations. In Figure \@ref(fig:densityplots) there are three links total volume shown each with different facility types. The green dashed lines are the links measured AAWDT value, and the red dashed lines are the base scenario total volume value. These plots show that across each facility type with an AAWDT value, the variance in total volume is within the range of uncertainty already expected within the model. Since the AAWDT is so different from the Total Volume value, the uncertainty lies more within the model, than within the change in parameter values.

```{r densityplots, warning = FALSE, echo = FALSE, message = FALSE, fig.align="center", out.width = "75%", results='asis', fig.cap = "Total Volume Density for an Individual Link by Facility Type"}
density <- networks %>%
  filter(link %in% c("2496_2546", "3709_3701", "4575_4545")) %>%
  mutate(NAME = case_when(link == "2496_2546" ~ "Freeway Link",
                          link == "3709_3701" ~ "Arterial Link",
                          link == "4575_4545" ~ "Local Link"))

value <- density %>%
  filter(fileName == "BASE")

density %>%
 ggplot() +
  aes(x = TOTAL_VOL) +
  geom_density(adjust = 1L, fill = "gray") +
  geom_vline(data = value, mapping = aes(xintercept = TOTAL_VOL), linetype = "dashed", color = "red") +
  geom_vline(data = value, mapping = aes(xintercept = AAWDT), linetype = "dashed", color = "green") +
  theme_linedraw() +
  facet_wrap(~ NAME, scales = "free", ncol = 1) +
  labs(x = "Total Link Volume")
```

Figure \@ref(fig:networksd) displays both standard deviation, and the corresponding average volume amoung iterations on each link. This shows that there is a higher standard deviation on roads with high volumes, but a change in 600 vehicles on a road with 40,000 daily volume is minuscule. That is only a 1% variation in volume which is insignificant.

```{r networksd, warning = FALSE, echo = FALSE, message = FALSE, fig.align="center", out.width = "75%", results='hide', fig.keep='all', fig.cap = "Standard Deviation of Total Volume"}
shape <- st_read("data/sensitivity_out/BASE_LOADED.shp", crs = 4326)

modified_shp <- shape %>%
  left_join(base_total, by = c("A" = "A", "B" = "B")) %>%
  filter(mean > 0)

ggplot() +
  annotation_map_tile("cartolight", zoom = 11) +
  geom_sf(data = modified_shp, aes(color = sd, linewidth = mean), alpha = 0.5) +
  theme_map() +
  scale_colour_gradientn(colours=rainbow(4)) +
  labs(color = "Standard Deviation",
       linewidth = "Average Total Volume") +
  theme(legend.position = "left")
```

Another way to  visualize changes among each iteration is to look at how mode choices change. Figure \@ref(fig:modechoicetrips) shows that for home based work trips by each origin, the variance among each mode is less than 20%, and that transit varies the most.

```{r modechoicetrips, warning = FALSE, echo = FALSE, message = FALSE, fig.align="center", out.width = "75%", results='asis', fig.cap = "Origin Desnity for Coefficient of Variation by Mode for HBW Trips"}
tar_load(hbw_trips)

hbw_mc <- hbw_trips

hbw_mc[is.na(hbw_mc)] <- 0
  
hbw_mc2 <- hbw_mc %>%  
group_by(origin, draw) %>%
  summarize(Drive = sum(DA),
            Transit = sum(WLB),
            NonMotor = sum(NOM))

hbw_mc_cov <- hbw_mc2 %>%
  group_by(origin) %>%
  summarise(cov_Drive   =   sd(Drive)/mean(Drive),
            cov_Transit =   sd(Transit)/mean(Transit),
            cov_NonMotor =  sd(NonMotor)/mean(NonMotor)) %>%
  pivot_longer(cols = c("cov_Drive", "cov_Transit", "cov_NonMotor"), names_to = "mode", values_to = "cov")

hbw_mc_cov %>%
ggplot() +
  aes(x = cov, fill = mode, group = mode) +
  geom_density(adjust = 1L, alpha = 0.5) +
  scale_fill_hue(direction = 1) +
  theme_linedraw() +
  labs(x = "Coefficient of Variation",
       y = "Density",
       fill = "Mode")
```


## Summary