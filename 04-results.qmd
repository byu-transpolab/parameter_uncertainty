# Results {#sec-results}

```{r res-setup, include = FALSE}
# load R libraries here; the `include` flag in the chunk options above tells
# whether to print the results or not. Usually you don't want to print the
# library statements, or any code on the pdf.
# Main Packages ========
# I use these in every doc
library(tidyverse)
library(knitr)
library(kableExtra)
library(modelsummary)
library(targets)
options(dplyr.summarise.inform = FALSE)
# Other packages ------
# These sometimes get used, and sometimes don't.
library(leaflet)
library(sf)
library(viridis)
library(ggspatial)
library(ggthemes)
# Instructions and options =========
# prints missing data in tables as blank space
options(knitr.kable.NA = '') 
# tells kableExtra to not load latex table packages in the chunk output
options(kableExtra.latex.load_packages = FALSE) 
# round and format numbers that get printed in the text of the article.
inline_hook <- function(x) {
  if (is.numeric(x)) {
    format(x, digits = 3, big.mark = ",")
  } else x
}
knitr::knit_hooks$set(inline = inline_hook)
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
# options for latex-only output
if(knitr::is_latex_output()) {
  knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
} 
theme_set(theme_bw())

tar_load(networks)

base <- foreign::read.dbf("data/sensitivity_out/BASE_LOADED.DBF") %>%
  mutate(link = paste(A, B, sep = "_"))
```

Each of the 100 parameter draws was applied to the RVTPO model, generating
mode choice utilities, destination choice utilities, and trip matrices for 
each draw. 

@fig-linkcv shows the coefficient of variation for the daily volume assigned to
each network link across the 100 draws, plotted against the mean forecasted
link volume for each link. The results suggest that for high-volume roads such
as major arterials and freeways, the coefficient of variation converges to 
approximately 0.01, or
about 1% of the road's total forecasted volume. For lower-volume links, the
coefficient of variation is more widely distributed, with some local roads and
small collectors having considerably higher values. Some links in the model
show no variation at all; these are presumably links near the edges of the 
model region where the only traffic is to and from external zones, trips which
were held constant in this framework. 


```{r linkcv}
#| fig-cap: Coefficient of variation in daily volume links
#| label: fig-linkcv
links_total <- networks %>%
  group_by(link) %>%
  summarize(sd = sd(TOTAL_VOL),
            mean = mean(TOTAL_VOL))

base_total <- merge(base, links_total, by = "link") %>%
  mutate(cov = sd/mean) %>%
  filter(FACTYPE < 11, mean >0 ) %>%
  mutate(FacilityType = case_when(FACTYPE %in% 1:2 ~ "Freeway",
                                  FACTYPE %in% 3:5 ~ "Arterial",
                                  FACTYPE %in% 6:7 ~ "Collector",
                                  FACTYPE == 8 ~ "Local",
                                  FACTYPE %in% 9:10 ~ "Ramp",
  ))

ggplot(base_total) +
  aes(x = TOTAL_VOL, y = cov, color = FacilityType) +
  geom_point(shape = "circle", size = 1.5, alpha = 0.35) +
  theme_linedraw() + scale_y_log10() +
  labs(x = "Mean forecasted link volume",
       y = "log(Coefficient of Variation)",
       color = "Facility Type")
```



Variation among a link can also be visualized with a density plot of the
total volume across all iterations, as shown in @fig-linkdens.
In this plot, the density of forecasted volumes in three randomly selected links
in each of the freeway, collector, and arterial functional types are plotted 
alongside the baseline forecast (using the values in @tab-coefs) and the AAWDT
measured by the Virginia Department of Transportation, and to which the 
model estimates were calibrated. In all cases, the error or uncertainty in the
forecast is considerably narrower than the error inherent in the model construction,
as evidenced by the fact that the AAWDT target value is well outside the 
bell curve created the statistically varied simulation forecasts. 



```{r linkdens}
#| fig-cap: Density plot of forecasted volume on selected links, with default parameter results marked in red, and AAWDT values in green.
#| label: fig-linkdens
set.seed(43)
link_sample <- networks |> 
  filter(AAWDT > 0) |> 
  filter(FACTYPE < 11) |> 
  mutate(FacilityType = case_when(FACTYPE %in% 1:2 ~ "Freeway",
                                  FACTYPE %in% 3:5 ~ "Arterial",
                                  FACTYPE %in% 6:7 ~ "Collector",
                                  TRUE ~ "drop"
  )) |> 
  filter(FacilityType != "drop") |> 
  group_by(FacilityType) |> 
  sample_n(3) |> 
  pull(link)

density <- networks %>%
  filter(link %in% link_sample) %>%
  mutate(FacilityType = case_when(FACTYPE %in% 1:2 ~ "Freeway",
                                  FACTYPE %in% 3:5 ~ "Arterial",
                                  FACTYPE %in% 6:7 ~ "Collector",
                                  TRUE ~ "drop"
  ))

value <- density %>%
  filter(fileName == "BASE")

density %>%
 ggplot() +
  aes(x = TOTAL_VOL, fill = FacilityType) +
  geom_density(adjust = 1L, alpha = 0.5) +
  facet_wrap(~link, scales = "free") + 
  geom_vline(data = value, mapping = aes(xintercept = TOTAL_VOL), 
             linetype = "dashed", color = "red") +
  geom_vline(data = value, mapping = aes(xintercept = AAWDT), 
             linetype = "dashed", color = "green") +
  theme_bw() +
  labs(x = "Total Link Volume")
```

As expected from using the default parameter values as the mean of the LHS
parameter sampling, the default results are at or near the median of the statistical
density for each link's volume. But it is notable that the estimated volumes are
not perfectly, normally distributed as might be naively expected. In this case,
the combined effects of the mode and destination choice parameter sampling appear
to be constrained by the geographic specificity of the RVTPO model network: even 
when the demand for trips changes between zone pairs, the realities of the 
highway capacity, volume-delay, and static user equilibrium procedures may be
limiting the possibilities for forecasted highway volumes.

@fig-networksd displays the variation in forecasted link volume spatially. 
As indicated by --- and consistent with --- the previous results, the links
with the highest standard deviation in forecasted volume are high-volume roads
including freeways and principal arterials where the majority of traffic is 
internal to the study region. 

```{r networksd, message=FALSE}
#| fig-cap: Standard deviation in forecasted volume.
#| label: fig-networksd
shape <- st_read("data/sensitivity_out/BASE_LOADED.shp", crs = 4326, quiet = TRUE)

modified_shp <- shape %>%
  filter(FACTYPE < 7) %>%
  left_join(base_total, by = c("A" = "A", "B" = "B")) %>%
  filter(mean > 0)

ggplot() +
  annotation_map_tile("stamenbw", zoom = 11) +
  geom_sf(data = modified_shp, aes(color = sd, size = mean), alpha = 0.5) +
  theme_map() +
  scale_colour_gradientn(colours=rainbow(4)) +
  scale_size("Volume") +
  labs(color = "Standard Deviation",
       linewidth = "Average Total Volume") +
  theme(legend.position = "left")
```


